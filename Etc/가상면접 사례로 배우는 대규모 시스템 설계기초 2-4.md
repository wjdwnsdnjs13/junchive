# 7장 - 호텔 예약 시스템

## 1단계 - 문제 이해 및 설계 범위 확정
- 설계 범위 확정
  - Q) 시스템 규모?
    - A) 5000개 호텔에서 100만 개의 객실을 갖춘 호텔 체인을 위한 웹 사이트 구현
  - Q) 대금은 예약 시인지, 호텔 도착 시인지?
    - A) 시간 제한이 있어 예약 시 전부 지불로 가정
  - Q) 웹사이트에서만 예약이 되는가, 전화 같은 것도 되는가?
    - A) 웹 사이트나 앱에서만 가능.
  - Q) 예약 취소 기능은?
    - A) 물론임
  - Q) 추가 고려 사항은?
    - A) 10% 초과 예약이 가능해야 함. 실제 객실보다 많이 판매 가능
  - Q) 시간이 제한되어 있어 검색은 제외하고자 함.
    - 호텔 정보 페이지
    - 객실 정보 페이지
    - 객실 예약 지원
    - 호텔이나 객실 정보 추가/삭제/갱신하는 관리자 페이지
    - 초과 예약 지원
    - A) 굳
    - A) 객실 가격은 유동적임. 객실 여유에 따라 유동적으로 변경되며 매일 달라짐

### 비기능 요구 사항
- 적절한 지연 시간
  - 예약 시 응답 시간이 빠르면 이상적인데, 몇 초 정도 지연은 괜찮음

### 개략적 규모 추정
- 5000개 호텔, 100만 개의 객실
- 객실의 70%가 사용 중이고, 평균 투숙 기간은 3일이라고 가정
- 일일 예약 건수 : 233_333건
  - 100만 * 0.7 / 3
- 초당 예약 건수 약 3건(TPS)
  - 240_000 / 하루
- 웹 사이트 사용 흐름
  - 호텔/객실 상세 페이지
    - 호텔/객실 정보를 확인 -> 조회
  - 예약 상세 정보 페이지
    - 사용자가 날짜, 투숙 인원, 결제 방법 등의 상세 정보 확인 -> 조회
  - 객실 예약 페이지
    - 사용자가 '예약'버튼을 눌러 객실을 예약 -> 트랜잭션 발생
- 대략 10%만 다음 단계로 진입하고 그 외에는 흐름을 이탈한다고 가정
  - 객실 상세 페이지 QPS = 300
  - 예약 상세 정보 페이지 QPS = 30
  - 객실 예약 페이지 QPS = 3

## 2단계 - 개략적 설계안 제시 및 동의 구하기
### API 설계 - 호텔 관련 API
| API                        | 설명              |
|----------------------------|-----------------|
| GET v1/hotel/{hotel_id}    | 호텔 정보 조회        |
| POST v1/hotels             | 신규 호텔 추가, 직원 전용 |
| PUT v1/hotel/{hotel_id}    | 호텔 정보 갱신, 직원 전용 |
| DELETE v1/hotel/{hotel_id} | 호텔 삭제, 직원 전용    |

### API 설계 - 객실 관련 API
| API                                      | 설명              |
|------------------------------------------|-----------------|
| GET v1/hotels/{hotel_id}/rooms/{room_id} | 객실 정보 조회        |
| POST v1/hotels/{hotel_id}/rooms          | 신규 객실 추가, 직원 전용 |
| PUT v1/hotels/{hotel_id}/rooms/{room_id} | 객실 정보 갱신, 직원 전용 |
| DELETE v1/hotels/{hotel_id}/rooms/{room_id} | 객실 삭제, 직원 전용    |

### API 설계 - 예약 관련 API
| API                                   | 설명            |
|---------------------------------------|---------------|
| GET v1/reservations | 사용자의 예약 이력 조회 |
| GET v1/reservations/{reservation_id} | 예약 정보 조회 |
| POST v1/reservations | 객실 예약 |
| DELETE v1/reservations/{reservation_id} | 예약 취소 |

### 데이터 모델
- 예약 시스템이 지원해야 할 질의
  - 호텔 상세 정보 확인
  - 지정된 날짜 범위에 사용 가능한 객실 유형 확인
  - 예약 정보 기록
  - 예약 내역 또는 과거 예약 이력 정보 조회
- RDB를 선택
  - 읽기 쓰기 빈도가 쓰기 연산에 비해 높은 흐름을 잘 지원함
    - 웹 사이트와 앱을 방문하는 사용자 수가 예약자 수에 비해 압도적으로 많음
    - NoSQL은 쓰기 연산에 최적화 되어 있음
  - ACID(원자성, 일관성, 고립성, 지속성)을 보장함
    - 예약에서 ACID는 매우 중요함
    - 이중 청구, 잔액 마이너스, 이중 예약 등 방지가 필요함
  - 비즈니스 데이터 구조를 쉽게 모델링 가능
    - 엔티티 간의 관계를 안정적으로 지원

### RDB 엔티티 설계 시 주의점
- room_id가 에어비엔비 같은 회사에는 적합하지만, 호텔에는 그렇지 않을 수 있음.
- 호텔은 특정 룸을 예약하기 보다 '특정 객실 유형'을 예약하기 때문임

### 개략적 설계안
- 사용자
  - 객실을 예약하는 당사자
- 관리자(호텔 직원)
  - 고객 환불, 예약 취소, 객실 정보 갱신 등의 관리 작업을 수행
- CDN
  - JS 코드 번들, 이미지, 동영상, HTML 등 모든 정적 콘텐츠를 캐시해 웹 사이트 로드 성능을 개선
- 공개 API 게이트웨이
  - 처리율 제한, 인증 등의 기능을 지원하는 완전 관리형 서비스
  - 엔드포인트 기반으로 특정 서비스에 요청을 전달할 수 있게 구성
- 내부 API
  - 승인된 호텔 직원만 사용 가능한 API
  - VPN 등을 이용해 외부 공격으로부터 보호함
- 호텔 서비스
  - 호텔과 객실에 대한 정보를 제공
  - 대부분 정적이라 쉽게 캐시 가능
- 요금 서비스
  - 어떤 때에 어떤 요금을 받아야 하는지 데이터를 제공하는 서비스
  - 객실 요금이 해당 날짜에 호텔에 얼마나 손님이 몰리냐에 따라 달라짐
- 예약 서비스
  - 예약 요청을 받고 객실을 예약하는 과정을 처리.
  - 객실이 예약되거나 취소될 때 잔여 객실 정보를 갱신하는 역하도 담당
- 결제 서비스
  - 고객의 결제를 맡아 처리하고, 절차가 마무리되면 예약 상태를 결제 완료로 갱신
  - 실패한 경우 승인 실패로 업데이트
- 호텔 관리 서비스
  - 승인된 호텔 지원만 사용 가능.
  - 임박한 예약 기록 확인, 고객 객실 예약, 예약 취소 등의 기능을 제공

## 3단계 - 상세 설계
### 개선된 데이터 모델
- API 인자 변경
  - 예약 API에서 호출 인자를 roomID -> roomTypeID로 변경
- 스키마 변경
  - room 스키마에서 room_type_iD를 추가
  - 예약 서비스쪽 스키마에서도 room_id -> room_type_id로 변경
  - room_type_inventory 테이블
    - 호텔의 모든 객실 유형을 담는 테이블
    - 예약 시 아주 중요함.
    - hotel_id : 호텔 식별자
    - room_type_id : 객실 유형 식별자
    - date : 일자
    - total_inventory : 총 객실 수에서 일시적으로 제외한 객실 수를 뺀 값
      - 유지 보수 등의 사유로 예약 불가능 할 수 있음
    - total_reserverd : 지정된 hotel_id, room_type_id, date에 대한 예약된 객실 수
    - 날짜당 하나의 레코드를 사용 시 날짜 범위 내에서 예약을 쉽게 관리하고 질의 가능함
    - hotel_id, room_type_id, date를 복합 키로 사용함
    - 5000개의 호텔이 있고 각 호텔에 20개의 객실 유형이 있을 경우 레코드의 수 = 7_300만 개
    - 5000 * 20 * 2년 * 365

## 4단계 - 마무리

---