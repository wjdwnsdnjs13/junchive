# 1장 - 근접성 서비스
- 근접성 서비스는 현재 위치에서 가까운 시설을 찾는 데 이용

## 1단계 - 문제 이해 및 설계 범위 확정
- 설계 범위 줄이기
  - Q) 사용자가 검색 범위를 지정할 수 있어야 하는가? 반경 내 표시할 사업장이 충분하지 않을 경우 시스템이 알아서 확장해도 되는가?
    - A) 일단 주어진 반경 내의 사업장만 대상으로 함. 시간이 남으면 이후 처리를 고려
  - Q) 최대 반경은? 20km로 해도 되는가?
    - A) ok
  - Q) 사용자가 UI에서 검색 반경을 변경할 수 있는가?
    - A) 네. 0.5km, 1km, 2km, 5km, 20km 중 선택 가능
  - Q) 사업장 정보는 어떻게 시스템에 추가/삭제/갱신 되는가? 사업장에 대한 작업 정보가 실시간으로 유저에게 보여야 하는가?
    - A) 소유주가 정보를 추가/삭제/갱신 할 수 있어야 함. 새로 추가되거나 갱신한 정보는 다음 날까지 반영됨
  - Q) 사용자가 이동 중 앱이나 웹사이트 이용 시 항상 현재 위치 기준을 유지하기 위해 자동 갱신해야 하는가?
    - A) 사용자 이동 속도가 그리 빠르지 않아서 상시 갱신은 필요 없다고 가정
- 기능 요구사항
  - 사용자의 위치(경도와 위도 쌍)와 검색 반경 정보에 매치되는 사업장 목록 반환
  - 소유주가 사업장 정보를 추가/삭제/갱신할 수 있도록 하되, 그 정보가 실시간 반영은 아니어도 된다
  - 고객은 사업장의 상세 정보를 볼 수 있어야 함
- 비기능 요구 사항
  - 낮은 응답 지연
  - 데이터 보호
    - 위치 기반 서비스(LBS, Location-Based Service)는 사용자의 위치 정보를 다루므로 데이터 보호가 중요
    - GDPR(General Data Protection Regulation)
    - CCPA(California Consumer Privacy Act)
  - 고가용성, 규모 확장성

### 개략적 규모 추정
- DAU 1억명
- 등록된 사업장 수 2억
- QPS : 5000
  - 하루 평균 5회 검색한다고 가정
  - 하루를 10만초로 가정
  - 1억 * 5 / 10만 = 5000

## 2단계 - 개략적 설계안 제시 및 동의 구하기
### API 설계
- GET /v1/search/nearby
  - 특정 검색 기준에 맞는 사업장 목록을 반환
  - 보통 페이지 단위로 나눠 반환
  - 요청
    - `latitude` : 사용자의 위도
    - `longitude` : 사용자의 경도
    - `radius` : 검색 반경
    - 응답
      ```json 
        {
          "total": 10,
          "businesses": [{business object}]
        }
      ```
      - business object에는 사업장 상세 정보들이 담긴다

### 데이터 모델 - 읽기/쓰기 비율 
- 읽기 연산이 매우 자주 수행됨.
  - 주변 사업장 검색
  - 사업장 정보 확인
- 쓰기 연산의 빈도는 적음.
- 읽기 연산이 압도적일 결우 RDB가 유리할 수 있다.
      
### 개략적 설계안
- 로드밸런서
  - 유입 트래픽을 자동으로 여러 서비스에 분산
  - 로드밸런서를 단일 DNS 진입점(entry point)로 지정하고, URL 경로를 분석해 어느 서비스에 트래픽을 전달할지 결정
- 위치 기반 서비스(LBS)
  - LBS는 시스템의 핵심 부분
  - 주어진 위치와 반경 정보를 이용해 주변 사업장을 검색
  - 특징
    - 쓰기 요청이 없는, 읽기 요청만 빈번하게 발생
    - QPS가 높음.
      - 특정 시간대의 인구 밀집 지역일수록 심함
    - 무상태 서비스라서 수평적 규모 확장이 쉬움
- 사업장 서비스
  - 사업장 소유주가 사업장 정보를 생성, 갱신, 삭제함.
  - 기본적으로 쓰기 요청으로 QPS가 낮음
  - 고객이 사업장 정보를 조회.
    - 특정 시간대에 QPS가 높아짐
- DB 클러스터
  - primary-secondary DB 형태로 구성할 수 있음.
  - 주 DB는 쓰기 요청을 처리, 부 DB는 읽기 요청을 처리
  - 복제에 걸리는 시간(delay) 때문에 주 DB와 부 DB의 데이터에 차이가 있을 수 있음.
    - 사업장 정보가 실시간으로 갱신될 필요가 없어서 보통 문제되지 않음.
- 사업장 서비스와 LBS의 규모 확장성
  - 둘 다 무상태 서비스이므로 확장과 축소가 쉬움

### 주변 사업장 검색 알고리즘
- Redis의 지오해시(Geohash)나 PostGIS 확장을 설치한 Postgres DB를 활용함
- 내부 구조는 어려우니 몰라도 될 수 있음.
- DB의 이름 나열보다는 지리적 위치 색인이 어떻게 동작하는지 설명해 문제 풀이 능력과 기술 지식을 강초하는 것이 좋음.

### 주변 사업장 검색 알고리즘 방안 1 - 2차원 검색
- 주어진 반경으로 그린 원 안에 놓인 사업장을 검색하는 방법
- 가장 직관적이지만, 지나치게 단순하다는 문제가 있음
- SQL 문
  - SELECT * FROM businesses WHERE (latitude BETWEEN {:my_lat} - radius AND {:my_lat} + radius) AND (longitude BETWEEN {:my_long} - radius AND {:my_long} + radius)
  - 전체 테이블을 읽으므로 비효율적
- 위도 경도 칼럼에 색인 사용
  - 위도와 경도 각각에 해당하는 데이터 집합은 금방 추출 가능
  - 두 집합의 교집합을 구할 때 효율적이지 않음.
- **DB 색인은 한 차원의 검색 속도만 개선**
- 지리적 정보를 색인하는 방법
  - 해시 기반
    - 균등 격자(even grid), 지오해시(geohash), 카르테시안 계층(cartiesian tiers) 등
  - 트리 기반
    - 쿼드트리(quadtrees), 구글 S2, R-트리(R-trees) 등
  - 각 구현 방법은 서로 다르지만, 개략적 아이디어는 동일함
    - **지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인을 만듦**
    - 지오해시, 쿼드트리, 구글 S2가 실제로 많이 사용됨

### 주변 사업장 검색 알고리즘 방안 2 - 균등 격자
- 지도를 격자 또는 구획으로 나누는 단순한 접근법
- 

### 주변 사업장 검색 알고리즘 방안 3 - 지오해시(Geohash)

## 3단계 - 상세 설계

## 4단계 - 마무리




---
# 2장 - 주변 친구
## 1단계 - 문제 이해 및 설계 범위 확정

## 2단계 - 개략적 설계안 제시 및 동의 구하기

## 3단계 - 상세 설계

## 4단계 - 마무리
---
# 3장 - 구글 맵
## 1단계 - 문제 이해 및 설계 범위 확정

## 2단계 - 개략적 설계안 제시 및 동의 구하기

## 3단계 - 상세 설계

## 4단계 - 마무리