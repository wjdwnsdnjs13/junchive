# 13장 - 증권 거래소
## 1단계 -  문제 이해 및 설계 범위 확정
- 요구 사항 파악
  - Q) 어떤 증권을 거래한다고 가정하는가? 주식, 옵션, 선물 등
    - A) 간단하게 주식만 거래한다고 가정함
  - Q) 새 주문, 주문 취소, 주문 교체 중 어떤 유형의 주문을 지원해야 하는가? 지정가 주문(limite order), 시장가 주문(market order), 조건부 주문(conditional order) 등 주문 유형을 전부 지원해야 하는가?
    - A) 새 주문을 넣을 수 있고 체결되지 않은 주문은 취소할 수 있어야 함. 주문 유형은 지정가 주문만 가능하다고 가정함
  - Q) 시간 외 거래(after hours trading)도 지원해야 하는가?
    - A) 노. 시간 내 거래만 처리할 수 있으면 됨
  - Q) 거래소가 갖추어야 할 기본 기능은? 사용자 수, 증권 가지수나 주문 수 등 거래소 규모에 대한 부분은?
    - A) 새로운 지정가 주문을 접수하거나 기존 주문을 취소할 수 있어야 함.
    - 주문 체결 시 실시간으로 알 수 있어야 함.
    - 호가 창의 정보는 실시간으로 갱신되어야 함.
    - 호가 창은 매수 및 매도 주문 목록이 표시되는 곳임.
    - 최소 수만 명 사용자가 동시에 거래할 수 있어야 하고, 최소 100가지 주식 거래가 가능해야 함
    - 거래량의 경우 하루 수십억 건의 주문이 발생할 수 있음
    - 거래소는 규제 시설이므로 위험성 점검이 가능해야 함
  - Q) 위험성 점검에 대해 조금 더 설명해 줄 수 있는가?
    - A) 간단한 점검만 가능하면 됨.
    - 한 사용자가 하루 거래할 수 있는 애플 주식을 백만 주 이하로 제한하는 규칙이 있다고 했을 때, 해당 규칙을 위한하는 거래가 이루어지지 않도록 점검하면 됨
  - Q) 사용자 지갑 관리에 대해서는 언급이 없는데, 이 부분도 고려하는가?
    - A) 주문 전 자금이 충분한지 먼저확인하는 게 좋음.
    - 아직 아직 체결되지 않은 주문이 있는 경우, 해당 주문에 사용된 자금은 다른 주문에 쓰일 수 없어야 함

### 비기능 요구 사항
- 가용성
  - 거래소에서 가용성은 매우 중요한 문제임
- 결함 내성
  - 프로덕션 장애의 파급을 줄이려면 결함 내성과 빠른 복구 매커니즘이 필요함
- 지연 시간
  - 왕복 지연 시간은 밀리초 수준이어야 하고, p99 지연 시간이 중요함
  - 왕복 지연 시간은 주문이 거래소에 들어온 순간부터 주문 체결 사실이 반환되는 시점까지임
  - p99 지연 시간이 계속 높으면 일부 사용자의 거래소 이용 경험이 나빠짐
- 보안
  - 거래소는 계정 관리 시스템을 갖추어야 함
  - 법률 및 규정 준수를 위해 거래소는 새 계좌 개설 전에 사용자 신원 확인을 위한 KYC(Know Your Customer) 절차를 거쳐야 함
  - 시장 데이터가 포함된 웹 페이지 등 공개 자원의 경우 DDoS 공격을 방지해야함

### 개략적 규모 추정
- QPS
  - 43000
    - 10억 / 6.5시간 / 36000초 = ~43_000
- 최대 QPS
  - 215_000
    - QPS * 5배
    - 거래량은 장 시작 직후, 그리고 장 마감 직전에 훨씬 높음

## 2단계 - 개략적 설계안 제시 및 동의 구하기
### 증권 거래 101 - 브로커
- 대부분의 개인 고객은 브로커 시스템을 통해 거래소와 거래함
- 브로커 시스템은 개인 사용자가 증권을 거래하고 시장 데이터를 확인할 수 있도록 편리한 사용자 인턴페이스를 제공함

### 증권 거래 101 - 기관 고객
- 기관 고객은 전문 증권 거래 소프트웨어를 사용해 대량으로 거래함.
- 기관 고객마다 거래 시스템에 대한 요구 사항이 다름.
  - 연기금은 안정적인 수익을 목표로함
  - 어떤 헤지 펀드는 시장 조성을 전문으로해 수수료 리베이트로 수익을 얻음 

### 증권 거래 101 - 지정가 주문
- 지정가 주문은 가격이 고정된 매수 또는 매도 주문임
- 체결이 즉시 이루어지지 않을 수 있고, 부분적인 체결이 될 수도 있다.

### 증권 거래 101 - 시장가 주문
- 가격을 지정하지 않은 주문으로, 시장가로 즉시 체결됨
- 체결이 보장되지만 비용적으로 손해를 볼 수 있음

### 개략적 설계안
- 하나의 주문이 처리되는 절차
  - 지연 시간 요건이 중요한 중요 경로로 이 경로를 따라 흐르는 모든 정보는 신속하게 처리되어야 함
  - 1단계
    - 고객이 브로커의 웹 또는 모바일 앱을 통해 주문함
  - 2단계
    - 브로커가 주문을 거래소에 전송함
  - 3단계
    - 주문이 클라이언트 게이트웨이를 통해 거래소로 들어감
    - 클라이언트 게이트웨이는 입력 유효성 검사, 속도 제한, 인증, 정규화 등과 같은 기본적인 게이트키핑 기능을 수행함
    - 그런 다음 주문을 관리자에게 전달함
  - 4~5단계
    - 주문 관리자가 위험 관리자가 설정한 규칙에 따라 위험성 점검을 수행
  - 6단계
    - 위험성 점검 과정을 통과한 주문에 대해 주문 관리자는 지갑에 주문 처리 자금이 충분한지 확인
  - 7 ~ 9단계
    - 주문이 체결 엔진으로 전송됨
    - 체결 가능 주문이 발견되면 체결 엔진은 매수 측과 매도 측 각각 하나씩 두 개의 집행 기록을 생성함
    - 나중에 그 과정을 재생할 때 항상 결정론적(deterministic)으로 동일한 결과가 나오도록 보장하기 위해 시퀀서는 주문 및 집행 기록을 일정 순서로 정렬함
  - 10 ~ 14단계
    - 주문 집행 사실을 클라이언트에 전송
- 시장 데이터 흐름을 따라서 하나의 주문이 체결 엔진부터 데이터 서비스를 거쳐 브로커로 전달되어 집행되기까지의 가정을 추적
  - M1 단계
    - 체결 엔진은 주문이 체결되면 집행 기록 스트림을 만듦
    - 이 스트림은 시장 데이터 게시 서비스로 전송됨
  - M2 단계
    - 시장 데이터 게시 서비스는 집행 기록 및 주문 스트림에서 얻은 데이터를 시장 데이터로 사용해 봉 차트와 호가 창을 구성
    - 이후 시장 데이터를 데이터 서비스로 보냄
  - M3 단계
    - 시장 데이터는 실시간 분석 전용 스토리지에 저장됨
    - 브로커는 데이터 서비스를 통해 실시간 시장 데이터를 읽음
    - 브로커는 이 시장 데이터를 고객에게 전달함
- 마지막으로 보고 흐름을 살펴보자
  - R1 ~ R2 단계
    - 보고 서비스는 주문 및 실행 기록에서 보고에 필요한 모든 필드의 값을 모은 다음 그 값을 종합해 만든 레코드를 DB에 기록
      - client_id, price, quantity, order_type, filled_quantity, remaining_quantity 등
- 거래 흐름은 중요 경로를 따라 진행되지만 시장 데이터 흐름이나 보고 흐름은 그렇지 않음. 두 가지는 지연 요구사항이 다름

### 거래 흐름 - 체결 엔진
- 거래 흐름은 거래소 중요 경로상에서 진행됨.
- 모든 것은 신속하게 진행되어야 함.
- 거래 흐름의 핵심은 체결 엔진임
- 체결 엔진은 교차 엔진이라고도 함.
- 체결 엔진의 주요 역할
  - 각 주식 심벌에 대한 주문서 내지 호가 창을 유지 관리함
    - 주문서 또는 호가 창은 특정 주식에 대한 매수 및 매도 주문 목록임
    - 데이터 모델 절에서 호가 창 구성 방법을 자세히 설명함
  - 매수 주문과 매도 주문을 연결함.
    - 주문 체결 결과로 두 개의 집행 기록이 만들어짐.
    - 체결은 빠르고 신속하게 처리되어야 함
  - 집행 기록 스트림을 시장 데이터로 배포함
- 가용성이 높은 체결 엔진 구현체가 만드는 체결 순서는 결정론적이어야 함
- 입력으로 주어지는 주문 순서가 같으면 체결 엔진이 만드는 집행 기록 순서는 언제나 동일해야 함
  - 이러한 결정론적 특성이 고가용성의 토대가 됨

### 거래 흐름 - 시퀀서
- 시퀀서는 체결 엔진을 결정론적으로 만드는 핵심 구성 요소임
- 시퀀서는 체결 엔진에 주문을 전달하기 전 순서 ID를 붙여 보냄
- 체결 엔진이 처리를 끝낸 모든 집행 기록 쌍에도 순서 ID를 붙임
- 시퀀서는 입력 시퀀서와 출력 시퀀서 두 가지가 있고, 각각 고유한 순서를 유지함
- 입력되는 주문과 출력하는 실행 명령에 순서 ID를 찍는 이유
  - 시의성(timeliness) 및 공정성(fairness)
  - 빠른 복구(recovery) 및 재생(replay)
  - 정확한 1회 실행 보증(exactly-once guarantee)
- 시퀀서는 순서 ID만 생성하는 것이 아니라 메시지 큐의 역할도 함
  - 하나는 체결 엔진에 메시지(수신된 주문)을 보내는 큐 역할을 하고, 다른 하나는 주문 관리자에게 메시지(집행 기록)를 회신하는 큐 역할을 함
- 또한 주문과 집행 기록을 위한 이벤트 저장소로도 볼 수 있음
  - 체결 엔진에 두 개의 카프카 이벤트 스트림이 연결되어 있는 것과 유사함
  - 하나는 입력되는 주문용이고, 다른 하나는 출력될 집행 기록용
  - 카프카의 지연 시간이 더 짧고 예측 가능했다면 시퀀서 구현에 카프카를 사용할 수도 있었음

### 거래 흐름 - 주문 관리자
- 주문 관리자는 한쪽에서는 주문을 받고 다른 쪽에서는 집행 기록을 받음
- 주문 상태를 관리하는 것이 주문 관리자의 역할임
- 주문 관리자는 클라이언트 게이트웨이를 통해 주문을 수신하고 다음을 실행함
  - 종합적 위험 점검 담당 컴포넌트에 주문을 보내 위험성을 검토
    - 본 설계안이 지원해야 하는 위험 점검 규칙은 단순함.
      - 사용자의 거래량이 하루 100만 달러 미만인지 확인하는 정도
  - 사용자의 지갑에 거래를 처리하기에 충분한 자금이 있는지 확인
    - 지갑에 대해서는 12장 '전자 지갑'에서 자세히 설명했음
      - 거래서에서도 쓸 수 있을 만한 구현안임
  - 주문을 시퀀서에 전달
    - 시퀀서는 해당 주문에 순서 ID를 찍고 체결 엔진에 보내어 처리함
    - 새 주문에는 많은 속성이 있지만 모든 속성을 체결 엔진에 보낼 필요는 없음.
    - 메시지 크기를 줄이기 위해 주문 관리자는 필요한 속성만 전송함
- 주문 관리자는 시퀀서를 통해 체결 엔진으로부터 집행 기록을 받음
- 주문 관리자는 체결된 주문에 대한 집행 기록을 클라이언트 게이트웨이를 통해 브로커에 반환함
- 빠르고 효율적이며 정확해야 함
- 주문의 현재 상태를 유지 관리해야함.
- 다양한 상태 변화를 관리해야 하는 문제 때문에 주문 관리자의 구현은 아주 복잡함
- 실제 거래서 시스템일 경우 수만 가지 경우를 처리해야 함
  - 이벤트 소싱은 주문 관리자 설계에 적합함.