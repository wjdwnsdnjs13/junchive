# 3장 - 구글 맵
## 1단계 - 문제 이해 및 설계 범위 확정
- Q) DAU는?
  - A) 10억
- Q) 초점을 맞추는 기능은? e.g)방향 안내, 경로 안내, 예상 도착 시간(Estimated Time of Arrival, ETA) 등
  - A) 위치 갱신, 경로 안내, ETA 등에 초점을 맞춤
- Q) 도로 데이터는 어느 정도 규모인가? 도로 데이터는 있다는 가정 하에 진행하는가?
  - A) 도로 데이터는 다양한 경로로 확보해 두었다고 가정. 수 TB 수준의 가공되지 않은 데이터임.
- Q) 교통 상황도 고려해야 하는가?
  - A) 교통 상황은 도착 시간을 최대한 정확하게 추정하는 데 아주 중요함
- Q) 어떻게 이동하는지도 고려하는가?(이동 수단)
  - A) 다양한 이동 방법을 지원할 수 있어야 함.
- Q) 경로 안내 시 경유지를 여러 곳 설정 가능한가?
  - A) 경유지는 좋지만, 우선은 제외함.
- Q) 사업장 위치 및 사진도 표시해야하는가?
  - A) 사진은 우선 고려하지 않음

### 기능 요구 사항
- 사용자 위치 갱신
- 경로 안내 서비스(ETA 서비스 포함)
- 지도 표시
- 주 지원 단말은 모바일

### 비기능 요구사항 및 제약사항
- 정확도
- 부드러운 경로 표시
- 데이터 및 배터리 사용량
- 일반적으로 널리 통용되는 가용성 및 규모 확장성 요구 만족

### 지도 101 - 측위 시스템
- 측위 시스템은 축을 중심으로 회전하는 구에서 표면 상의 위치를 표현하는 체계
- 위도
  - 주어진 위치가 얼마나 북쪽/남쪽인지
- 경도
  - 얼마나 동쪽/서쪽인지

### 지도 101 - 3차원 위치의 2차원 변환
- 지도 투영법 또는 도법
  - 3차원 구 위의 위치를 2차원 평면에 대응시키는 절차
- 거의 모든 투영법은 실제 지형의 기하학적 특성을 왜곡한다는 공통점을 가짐

### 지도 101 - 지오코딩
- 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스
  - 서울 서초구 신반포로 194 -> 37.505664, 127.005844
- 주소를 좌표로 변환하는 것을 역지오코딩이라고 함
- 인터폴레이션 등을 사용해 지오코딩 수행 가능
  - GIS(Geographic Information System)와 같은 다양한 시스템이 제공하는 데이터를 결합한다는 의미
  - GIS는 도로망을 지리적 좌표 공간에 대응시키는 방법을 제공하는 여러 시스템 가운데 하나임

### 지도 101 - 지오해싱
- 지도 위 특정 영역을 영문자와 숫자로 구성된 짧은 문자열에 대응시키는 인코딩 체계
  - 2차원의 평면 공간으로 표현된 지리적 영역 위의 격자를 재귀적으로 더 작은 격자로 분할해 나감
- 맵 타일 관리에 지오해싱을 적용함

### 지도 101 - 지도표시
- 간단하게만 다루고 넘어감
- 가장 기본이 되는 개념은 타일
  - 지도를 하나의 이미지로 표시하는 대신 작은 타일로 쪼개어 표시함
  - 클라이언트는 사용자가 보는 영역과 관계된 타일만 다운받아 모자이크처럼 이어 붙인 다음 화면에 뿌림
  - 타일을 가져올 땐 지도 확대 수준에 따라서 가져온다.
    - 전체 지도를 다 보려고 할 때 모든 타일을 가져오는 것이 아니라 전세계를 특정 픽셀로 나타낸 타일 하나만 다운받는 형식

### 지도 101 - 경로 안내 알고리즘을 위한 도로 데이터 처리
- 대부분의 경로 탐색 알고리즘은 다익스트라나 A* 경로 탐색 알고리즘을 활용함
  - 최적의 알고리즘 하나를 고르는 것은 어려우므로 패스함
- 중요한 것은 교차로를 노드, 도로를 노드를 잇는 선으로 표현한다는 것
- 경로 탐색 알고리즘의 성능은 주어진 그래프 크기에 아주 민감함
  - 그래프의 크기가 커질수록 메모리도 많이 필요하고 탐색 시간이 길어짐
  - 지오해싱과 비슷한 방법으로 세계를 작은 격자로 나누고, 격자 안의 도로망을 그래프로 만들어 탐색 범위를 줄이는 방법이 있음
  - 각 격자는 경로 안내 타일(routing tile)이라 부름
  - 각 타일은 도로로 연결된 다른 타일에 대한 참조(reference)를 가지고 있음
  - 이렇게 해야 경로 탐색 알고리즘이 연결된 타일들을 지나갈 때 보일 더 큰 도로망 그래프를 만들어낼 수 있다
- 지도 타일은 PNG 이미지지만, 경로 안내 타일은 도로 데이터로 이루어진 이진 파일(binary file)임

### 지도 101 - 계층적 경로 안내 타일
- 경로 안내가 효과적으로 동작하려면 적정한 수준의 구체성을 갖춘 데이터가 필요함.
  - 너무 세분화된 데이터는 메모리 차지는 물론 너무 많은 시간이 걸릴 수 있음
- 보통 구체성 정도를 상/중/하 정도로 구분해 경로 안내 타일을 준비함
  - 지방도 데이터(local roads) -> 상
  - 더 넓게 규모가 큰 관할구(district)를 잇는 간선 도로(arterial roads) 데이터 -> 중
  - 구체성이 가장 낮은 도시와 도시를 연결하는 주요 고속도로 데이터 -> 하
  - 각 타일에는 다른 정밀도 타일로 연결되는 선(edge)가 있을 수 있음

### 개략적 규모 추정
- 설계 초점이 모바일 단말이므로 데이터 사용량과 배터리 효율을 중요하게 봐야함

### 개략적 규모 추정 - 저장소 사용량
- 저장해야할 데이터
  - 서계 지도
  - 메타데이터(metadata)
    - 각 지도 타일의 메타데이터는 크기가 아주 작아서 무시해도 될 정도이므로 패스함
  - 도로 정보
    - 외부에서 받은 수 TB 용량의 도로 데이터를 안내 타일로 변환
    - 변환 결과의 용량도 비슷할 것이라 예상

### 개략적 규모 추정 - 저장소 사용량 : 세계지도
- 지원하는 확대 수준(zoom level) 별로 지도 타일을 한 벌씩 두어야함
- 타일을 보관하는 데 필요한 용량을 가늠하려면 최대 확대 수준의 필요 타일 개수를 따져보는 것이 좋음
- 지도 확대 마다 4장의 타일로 펼친다고 가정
  - 세계 지도를 4의 제곱형태로 펼치므로 21번 확대하면 4.4조 개의 타일이 필요.
  - 256 * 256 픽셀의 압축 PNG 파일은 한 장에 100KB 정도의 용량이 필요함
  - 4.4조 * 100KB = 440PB
  - 다만, 사람이 살지 않는 지역 등에서는 높은 비율로 압축 가능하므로 80% 이상의 저장 용량을 절감할 수도 있다.
- 모든 수준의 타일을 표현하려면 100PB 정도 필요할 것 같음
  - 최대 수준의 타일을 50PB이라고 가정
  - 50PB + 50PB / 4 + 50PB / 16 + ... = 67PB 
  - 각 수준 별로 저장하는 타일 수는 1/4 수준으로 점점 줄어듦

### 개략적 규모 추정 - 서버 대역폭
- 서버 대역폭 추정을 위해서는 어떤 유형의 요청을 처리해야 하는지 살펴봐야 함
  - 경로 안내 요청
    - 클라가 경로 안내 세션을 시작할 때 전송하는 메시지
    - 사용자가 주 당 35분 사용한다고 가정
    - 주 350억 분, 하루에 50억 분
  - 위치 갱신 요청
    - 경로 안내 진행하는 동안 변경된 사용자 위치를 전송하는 메시지
  - 단순하게 매 초 GPS 좌표를 요청하면 하루 3000억 건의 요청이 발생(50억 분 * 60)
    - 300만 QPS
    - 갱신 요청 주기를 15초나 30초로 하면 QPS를 낮출 수 있음
    - 15초로 할 경우 20만 QPS로 확 줄어듦
      - 최대 QPS는 5배로 가정하면 약 100만 QPS


## 2단계 - 개략적 설계안 제시 및 동의 구하기


## 3단계 - 상세 설계


## 4단계 - 마무리


---
# 4장 - 분산 메시지 큐


## 1단계 - 문제 이해 및 설계 범위 확정


## 2단계 - 개략적 설계안 제시 및 동의 구하기


## 3단계 - 상세 설계


## 4단계 - 마무리

