# 5장 - 지표 모니터링 및 경보 시스템
## 1단계 - 문제 이해 및 설계 범위 확정
- 설계 범위 확정
  - Q) 시스템의 사용자는 누구인가, 대형 IT 업체 회사 내부 시스템인지, 데이터독 같은 SaaS 서비스인지?
    - A) 회사 내부 시스템임
  - Q) 어떤 지표를 수집해야 하는가?
    - A) 시스템 운영 지표(operational system metrics)를 수집.
      - CPU 부하, 메모리 사용률, 디스크 사용량 같은 저수준의 운영체제 사용률 지표
      - 서버가 처리하는 초당 요청 수(requests per second)
      - 사업 지표(business metrics)는 제외함.
  - Q) 모니터링할 인프라 규모는?
    - A) DAU는 1억, 1000개의 서버 풀이 있고 풀마다 100개의 서버 하드웨어를 유지함
  - Q) 지표 데이터 보관 기간은?
    - A) 1년 간 보관
  - Q) 장기 보관 시 지표의 해상도를 낮춰도 되는가?
    - A) 새로 수집한 데이터는 7일 보관, 7일 뒤에는 1분 단위 데이터로 30일 보관, 이후에는 1시간 단위 데이터로 변환해서 보관
  - Q) 경보 채널로 지원하는 것은?
    - A) 이메일, 전화, 페이저듀티, 웹훅 등을 지원
  - Q) 에러 로그나 액세스 로그 등에 대한 수집 기능도 필요한가?
    - A) 노
  - Q) 분산 시스템 추적(distributed system tracing)을 지원해야 하는가?
    - A) 노

### 개략적 요구사항 및 가정
- 대규모 인프라를 모니터링 함
  - DAU 1억
  - 서버 풀 1000개, 풀 당 서버 수 100개, 서버 당 100개의 운영 지표 수집.
    - 모니터링 해야하는 지표의 수는 천만 개 수준
  - 데이터 보관 기간은 1년
  - 수집한 그대로 데이터를 일주일간 보관, 7일 이후에는 1분 단위 데이터로 30일간 보관, 30일 이후에는 1시간 단위 데이터로 보관
- 모니터링할 지표
  - CPU 사용률
  - 요청 수
  - 메모리 사용량
  - 메시지 큐 내의 메시지 수

### 비기능 요구사항
- 규모 확장성
- 낮은 응답 지연
- 안정성
- 유연성
  - 기술 변화에 따라 새로운 기술을 쉽게 통합할 수 있게 유연하고 변경 가능한 파이프라인을 이용해 구축


- 고려하지 않아도 되는 요구사항
  - 엘라스틱서치, 로그스태시, 키바나 등과 같은 로그 모니터링 시스템
  - 분산 시스템 추적
    - 서비스에 대한 요청이 분산 시스템 내부를 어떻게 흘러 다니는지 추적할 수 있는 시스템
    - 요청이 한 서비스에서 다른 서비스로 이동할 때마다 데이터를 수집


## 2단계 - 개략적 설계안 제시 및 동의 구하기
### 기본적 사항
- 데이터 수집
- 데이터 전송
- 데이터 저장소
- 경보
- 시각화

### 데이터 모델
- 지표 데이터는 통상 시계열(time series) 데이터 형태로 기록함
  - 값 집합에 타임스탬프가 붙은 형태로 기록한다는 의미
- 시계열에는 고유한 이름이 붙고, 선택적으로 레이블(label)을 붙이기도 함 

### 데이터 접근 패턴
- 쓰기 부하가 막대함
- 읽기 부하는 일시적으로 잠시 치솟았다가 사라짐(spiky)

### 데이터 저장소 시스템
- RDB는 시계열 데이터 읽기 연산에 최적화되어 있지 않음
- NoSQL는 확장이 용이한 스키마를 사용하기 위해서 깊은 지식이 필요함.
- InfluxDB나 프로메테우스 등을 사용

### 개략적 설계안
- 지표 출처
  - 지표 데이터가 만들어지는 곳
  - 애플리케이션 서버, SQL DB, 메시지 큐 등 어떤 것이든 가능
- 지표 수집기
  - 지표 데이터를 수집하고 시계열 데이터에 기록
- 시계열 DB
  - 다량의 시계열 데이터를 분석하고 요약하는데 적합하게 설계된 질의 인터페이스 제공
- 질의 서비스
  - 시계열 DB에 보관된 데이터를 질의하고 가져오는 과정을 돕는 서비스
  - 적합한 시계열 DB를 잘 골랐으면 해당 서비스는 많은 일을 하지 않고, 심지어 필요 없을 수도 있음
- 경보 시스템
  - 경보를 받아야 하는 다양한 대상으로 알림을 전송
- 시각화 시스템
  - 지표를 다양한 형태의 그래프/차트로 시각화하는 기능 제공

## 3단계 - 상세 설계
### 지표 수집
- 카운터나 CPU 사용량 같은 지표를 수집할 때 데이터가 소실되어도 아주 심각한 문제는 아님
- 지표를 보내는 클라는 성공적으로 데이터를 전송했는지 신경 쓰지 않아도 됨

### 지표 수집 - 풀 모델
- 지표 수집기는 데이터를 가져올 서비스 목록을 알아야 함
- '지표 수집기' 서버 내에 모든 서비스 엔드포인트의 DNS/IP 정보를 담은 파일을 두면 간단함
- 서버가 수시로 추가/삭제되는 대규모 운영 환경에서 적합하지 않음.
- etcd나 주키퍼같은 서비스 탐색 기술 사용 시 해결 가능
- 지표 수집 흐름
  - SDS에서 서비스 엔트포인트 설정 메타 데이터 정보를 가져옴
  - 지표 수집기는 사전에 합의된 HTTP 엔드포트에서 지표 데이터를 가져 옴
  - 지표 수집기는 서비스 엔드포인트 목록의 변화를 통지 받기 위한 변경 이벤트 알림 콜백을 서비스 탐색 컴포넌트에 등록할 수 있음.
- 지표 수집기도 분산되어 있어야 함
- 분산되는 것으로 인해 여러 서버가 같은 출처의 데이터를 중복으로 가져오게 될 수 있음
- 한 가지 방법은 안정 해시 링이 있음


### 지표 수집 - 푸시 모델
- 지표 출처에 해당하는 서버가 직접 지표를 수신기에 전송하는 모델
- 모니터링 대상 서버에 통상 수집 에이전트라(coasldiont)는 설치되어 있음
  - 수집 에이전트는 지표 데이터를 수집하고 지표 수신기에 전송
  - 간단한 작업은 처리해서 주는 데이터 집계와 같은 작업은 수집기에 보내는 데이터의 양을 줄이는 데 효가적임
  - 

### 지표 전송 파이프라인의 규모 확장


### 질의 서비스


### 저장소 계층


### 경보 시스템


### 시각화 시스템

## 4단계 - 마무리


---
# 6장 - 광고 클릭 이벤트 집계