# 10장 - 알림 시스템 설계
## 1단계 - 문제 이해 및 설계 범위 확정
- 알림 시스템은 깊은 이해가 필요한 작업임.
- 정해진 정답이 없고 문제 자체가 모호하게 주어지는 것이 일반적이다.
- 요구 사항 구체화
  - Q) 이 시스템은 어떤 종류의 알림을 지원해야 하는가?
    - A) 이메일, 푸시 알림, SMS 등
  - Q) 실시간 시스템이어야 하는가?
    - A) 연성 실시간(soft real-time) 시스템이라고 가정. 알림은 빠르게 전달되어야 하지만, 시스템에 높은 부하가 걸렸을 때 약간의 지연은 허용함
  - Q) 사용자에게 보낼 알림은 누가 만들 수 있는가?
    - A) 클라이언트 애플리케이션 프로그램이 만들 수도 있고, 서버 측에서 스케쥴링할 수도 있다.
  - Q) 사용자가 알림을 비허용(opt-out)할 수 있어야 하는가?
    - A) 네
  - Q) 하루 몇 건의 알림을 보낼 수 있어야 하는가?
    - A) 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 함.

## 2단계 - 개략적 설계안 제시 및 동의 구하기
### 알림 유형별 지원 방안
- iOS 푸시 알림
  - 3가지 컴포넌트 필요
    - 알림 제공자
      - 알림 요청을 만들어 애플 푸시 알림 서비스(APNS)로 보내는 주체
        - 단말 토큰 : 알림을 보내는 데 필요한 고유 식별자
        - 페이로드 : 알림 내용을 담은 JSON 딕셔너리
    - APNS
      - 애플이 제공하는 원격 서비스. 푸시 알림을 iOS로 보내는 역할을 담당
    - iOS 단말
      - 푸시 알림을 수신하는 사용자 단말
- 안드로이드 푸시 알림
  - iOS와 비슷한 절차로 전송됨.
  - APNS 대신 FCM을 사용한다는 점만 다름.
- SMS 메시지
  - 트윌리오, 넥스모 같은 제 3 사업자의 서비스를 많이 이용
- 이메일
  - 대부분의 회사는 고유 이메일 서버를 구축할 역량은 갖추고 있음.
  - 그럼에도 상용 이메일 서비스를 이용
    - 센드그리드, 메일침프 등이 있음.

### 연락처 정보 수집 절차
- 알림을 보내기 위해서는 정보가 필요함.
  - 모바일 단말 토큰, 전화번호, 이메일 주소 등
- 한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말로 전송되어야 함

### 알림 전송 및 수신 절차
- 단일 알림 시스템
  - 1부터 N까지의 서비스
    - 사용자에게 납기일을 알리는 과금 서비스
    - 배송알림을 보내는 쇼핑몰 웹사이트 등
  - 알림 시스템
    - 알림 시스템은 알림 전송/수신 처리의 핵심임
    - 알림 전송을 위한 API를 제공해야함
    - 제 3자 서비스에 전달할 알림 페이로드를 만들 수 있어야 함
  - 제 3자 서비스
    - 사용자에게 알림을 실제로 전달하는 역할을 함
    - 확장성을 고려해야 함.
    - 어떤 서비스는 다른 시장에서 사용할 수 없을 수 있음.
      - 중국에서는 FCM을 사용할 수 없고, Jpush, PushY 같은 서비스를 사용해야 함
  - 단말
    - 단말에서 알림을 수신할 수 있어야 함
  - 문제
    - SPOF
    - 규모 확장성
    - 성능 병목
- 개선된 시스템
  - DB와 캐시를 알림 시스템의 주 서버에서 분리
  - 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어지도록 함
  - 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊어냄
  - 알림 서버
    - 알림 전송 API
    - 알림 검증
    - DB 또는 캐시 질의
    - 알림 전송
  - 캐시
    - 사용자 정보, 단말 정보, 알림 템플릿 등을 캐시
  - DB
    - 사용자, 알림, 설정 등의 정보를 저장
  - 메시지 큐
    - 시스템 컴포넌트 간 의존성 제거를 위해 사용
    - 다량의 알림 전송을 대비한 버퍼 역할도 수행
    - 제 3자 서비스 가운데 하나에 장애가 발생해도 다른 종류의 알림은 정상 동작
  - 작업 서버
    - 메시지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달하는 역할을 담당
  - 제 3자 서비스
  - 단말
  - 작업 순서
    - API를 호출해 알림 서버로 알림을 보냄
    - 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 DB에서 가져옴
    - 알림 서버는 전송할 알림에 맞는 이벤트를 만들어 해당 이벤트를 위한 큐에 넣음
    - 작업 서버는 메시지 큐에서 알림 이벤트를 꺼냄
    - 작업 서버는 알림을 제 3자 서비스로 보냄
    - 제 3자 서비스는 사용자 단말로 알림을 전송

## 3단계 - 상세 설계
### 안정성
- 데이터 손실 방지
  - 중요한 요구사항 가운데 하나는 알림이 소실되면 안되는 것임
    - 알림 지연이나 순서가 틀리는 것은 괜찮지만, 사라지는 것은 안됨
    - 이를 위해서는 알림 데이터를 DB에 ㅂ보관하고 재시도 메커니즘이 필요함
- 알림 중복 전송 방지
  - 알림이 반복되는 것을 완전히 막는 것은 불가능함.
  - 알림이 도착하면 이벤트의 ID를 검사해 이전에 본 적 있는 이벤트인지 확인

### 추가로 필요한 컴포넌트 및 고려사항
- 알림 템플릿
  - 파라미터나 스타일, 추적 링크 등만 조정하면 지정한 형식에 맞춰 알림을 만들어 내는 틀
- 알림 설정
  - 사용자가 알림 설정을 상세히 조정할 수 있도록 함
- 전송률 제한
  - 한 사용자가 받을 수 있는 알림의 빈도를 제한
- 재시도 방법
  - 제 3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣음
- 푸시 알림과 보안
  - iOS와 안드로이드 앱의 경우 알림 전송 API가 appKey와 appSecret을 사용해 보안을 유지함
- 큐 모니터링
  - 알림 시스템 모니터링 시 중요한 메트릭 하나는 큐에 쌓인 알림의 개수임
  - 알림의 개수가 많다는 말은 작업 서버가 이벤트를 빠르게 처리하지 못하고 있는 것이므로 작업 서버를 증설해야 함
- 이벤트 추적
  - 보통 알림 시스템을 만들 경우 데이터 분석 서비스와도 통합함

## 4단계 - 마무리
- 안정성
  - 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 매커니즘을 도입
- 보안
  - 인증된 클라이언트만 알림을 보낼 수 있도록 appKey, appSecert 등을 사용
- 이벤트 추적 및 모니터링
  - 알림 생성부터 전송 송공까지의 과정을 추적하고 시스템 상태를 모니터링하기 위해 이벤트를 추적하고 모니터링할 수 있는 시스템을 통합
- 사용자 설정
  - 사용자가 알림 수신 설정을 조정할 수 있도록 함.
- 전송률 제한
  - 사용자에게 알림을 보내는 빈도를 제한할 수 있도록 함